<p align="right">
  <a href="https://github.com/m-mitsuhide/axios-mock-server#readme">🇺🇸English</a> |
  <a href="https://github.com/m-mitsuhide/axios-mock-server/blob/develop/docs/ja/README.md">🇯🇵日本語</a>
</p>

<h1>axios-mock-server</h1>

[![npm version][badge-npm]][badge-npm-url]
[![npm bundle size][badge-bundlephobia]][badge-bundlephobia-url]
[![CircleCI][badge-ci]][badge-ci-url]
[![Codecov][badge-coverage]][badge-coverage-url]
[![Language grade: JavaScript][badge-lgtm]][badge-lgtm-url]
[![Dependabot Status][badge-dependabot]][dependabot]
[![License][badge-license]][axios-mock-server-license]

[axios][axios] を使った RESTful API のモックサーバー。

<details>
<summary><b>目次</b></summary>

<!--
This table of contents is generated by Markdown All in One in Visual Studio Code.
Please set the `githubCompatibility` option to `true`.
<https://marketplace.visualstudio.com/items?itemName=yzhang.markdown-all-in-one>
-->

- [特徴](#特徴)
- [入門](#入門)
  - [インストール](#インストール)
  - [チュートリアル](#チュートリアル)
    - [API の作成](#api-の作成)
    - [API のビルド](#api-のビルド)
    - [axios のモック化](#axios-のモック化)
  - [使用例](#使用例)
- [使い方](#使い方)
  - [API エンドポイントの作成](#api-エンドポイントの作成)
  - [axios との接続](#axios-との接続)
    - [デフォルト](#デフォルト)
    - [特定のインスタンスのみモックにする](#特定のインスタンスのみモックにする)
  - [関数](#関数)
    - [`setDelayTime(millisecond: number): void`](#setdelaytimemillisecond-number-void)
    - [`enableLog(): void` と `disableLog(): void`](#enablelog-void-と-disablelog-void)
  - [TypeScript](#typescript)
  - [注意事項](#注意事項)
    - [`.gitignore`](#gitignore)
    - [`@ts-ignore`, `eslint-disable`](#ts-ignore-eslint-disable)
- [トラブルシューティング](#トラブルシューティング)
  - [TypeScript で `The expected type comes from property 'get' which is declared here on type 'MockMethods'` のエラー](#typescript-で-the-expected-type-comes-from-property-get-which-is-declared-here-on-type-mockmethods-のエラー)
- [Command Line Interface のオプション](#command-line-interface-のオプション)
- [設定](#設定)
- [ライセンス](#ライセンス)

</details>

## 特徴

- `GET`/`POST`/`PUT`/`DELETE` の API エンドポイントを数行で作成できます。
- 専用のサーバーは不要です。
- 静的な [JavaScript][javascript] ファイルとして SPA でも動作します。
- [Node.js][nodejs] の環境でも [axios][axios] をモックにすることができます。
- [Nuxt.js][nuxtjs] 同様のオートルーティング機能があり、パスの記述は必要ありません。
- [TypeScript][typescript] に対応しています。

## 入門

### インストール

- [npm][npm] を使ってインストール:

  ```sh
  $ npm install axios
  $ npm install axios-mock-server --save-dev
  ```

- [Yarn][yarn] を使ってインストール:

  ```sh
  $ yarn add axios
  $ yarn add axios-mock-server --dev
  ```

### チュートリアル

axios-mock-server の最もシンプルな使い方を紹介します。

<details>
<summary><b>チュートリアルを始める</b></summary>

#### API の作成

まずはモックにするファイルを保存する `mocks` ディレクトリを作成します。

```sh
$ mkdir mocks
```

次に `mocks` ディレクトリの中に API のエンドポイントとなるファイルを作成します。  
`GET` リクエストでユーザーの基本情報を取得する API をモックとして定義してみましょう。

`mocks/users` ディレクトリを作り `_userId.js` ファイルを作成します。

```sh
$ mkdir mocks/users
$ touch mocks/users/_userId.js

# Windows の場合（コマンド プロンプト）
> mkdir mocks\users
> echo. > mocks\users\_userId.js
```

`mocks/users/_userId.js` のファイルには以下の記述を追加します。

<!-- prettier-ignore -->
```js
// ファイル: 'mocks/users/_userId.js'
const users = [{ id: 0, name: 'foo' }, { id: 1, name: 'bar' }]

module.exports = {
  get({ values }) {
    return [200, users.find(user => user.id === values.userId)]
  }
}
```

axios-mock-server のルーティングは [Nuxt.js][nuxtjs] のルーティングと同じように、`mocks` ディレクトリ内の **[JavaScript][javascript]、[TypeScript][typescript] ファイルのツリー構造に合わせて自動的に生成します。**

参考: [Routing - Nuxt.js][nuxtjs-routing]

つまり `mocks/users/_userId.js` のファイルは `/users/:userId` のパスとして、**動的なルーティングを利用したエンドポイントを定義することができます。**

#### API のビルド

axios-mock-server は実行前にルーティングに必要なファイルをビルドして生成する必要があります。  
コマンドラインから axios-mock-server に `--build` オプションを渡してビルドを開始します。

```sh
$ node_modules/.bin/axios-mock-server --build

# Windows の場合（コマンド プロンプト）
> node_modules\.bin\axios-mock-server --build
```

ビルドが成功すると `$mock.js` ファイルが `mocks` ディレクトリの中に生成されています。

```sh
$ cat mocks/\$mock.js
/* eslint-disable */
module.exports = (client) => require('axios-mock-server')([
  {
    path: '/users/_userId',
    methods: require('./users/_userId')
  }
], client)

# Windows の場合（コマンド プロンプト）
> type mocks\$mock.js
```

#### axios のモック化

最後に `index.js` ファイルなどで生成した `mocks/$mock.js` ファイルをインポートし、axios-mock-server の引数に渡せば完成です。  
axios-mock-server はデフォルトで [axios][axios] のすべての通信をモック化します。

<!-- prettier-ignore -->
```js
// ファイル: 'index.js'
const axios = require('axios')
const mock = require('./mocks/$mock.js')

mock()

axios.get('https://example.com/users/1').then(({ data }) => {
  console.log(data)
})
```

`index.js` ファイルを実行すると `{ id: 1, name: 'bar' }` が返ってくることがわかります。

```sh
$ node index.js
{ id: 1, name: 'bar' }
```

</details>

### 使用例

axios-mock-server は **ブラウザーでの利用** から **データの永続化**、**`multipart/form-data` 形式の通信** までモックにすることができます。  
また、**[Nuxt.js][nuxtjs]（[@nuxtjs/axios][nuxtjs-axios]） との連携** も簡単です。

ソースコードは [examples][axios-mock-server-examples] を参照してください。

<details>
<summary><b>使用例の一覧を見る</b></summary>

- **[browser](https://github.com/m-mitsuhide/axios-mock-server/tree/develop/examples/browser)**:
  ブラウザーでの使用例
- **[node](https://github.com/m-mitsuhide/axios-mock-server/tree/develop/examples/node)**:
  [Node.js][nodejs]（CommonJS）での使用例
- **[with-nuxtjs](https://github.com/m-mitsuhide/axios-mock-server/tree/develop/examples/with-nuxtjs)**:
  [Nuxt.js][nuxtjs] での使用例
- **[with-typescript](https://github.com/m-mitsuhide/axios-mock-server/tree/develop/examples/with-typescript)**:
  [TypeScript][typescript] での使用例

**WIP**

- with-in-memory-database

</details>

## 使い方

### API エンドポイントの作成

<!-- prettier-ignore -->
```js
const users = [{ id: 0, name: 'foo' }, { id: 1, name: 'bar' }]

/**
 * リクエストで引数として渡される変数の型定義
 * @typedef { Object } MockMethodParams
 * @property { import('axios').AxiosRequestConfig } config axios のリクエストの設定
 * @property {{ [key: string]: string | number }} values リクエストされた URL の動的な値（パスのアンダースコア部分）
 * @property {{ [key: string]: any }} params リクエストされた URL のクエリパラメータの値
 * @property { any } data POST などで送信されたリクエストデータ
 */

/**
 * レスポンスをオブジェクトとして返す場合の型定義
 * @typedef { Object } MockResponseObject
 * @property { number } status HTTP レスポンスステータスコード
 * @property { any? } data レスポンスデータ
 * @property {{ [key: string]: any }?} headers レスポンスヘッダー
 */

/**
 * レスポンスの型定義
 * @typedef { [number, any?, { [key: string]: any }?] | MockResponseObject } MockResponse
 */

export default {
  /**
   * GET、POST などすべてのメソッドの型は共通です
   * @param { MockMethodParams }
   * @returns { MockResponse }
   */
  get({ values }) {
    return [200, users.find(user => user.id === values.userId)]
  },

  /**
   * 非同期にレスポンスを返すこともできます
   * @param { MockMethodParams }
   * @returns { Promise<MockResponse> }
   */
  async post({ data }) {
    await new Promise(resolve => setTimeout(resolve, 1000))

    users.push({
      id: users.length,
      name: data.name
    })

    return { status: 201 }
  }
}
```

### axios との接続

#### デフォルト

axios-mock-server はデフォルトで [axios][axios] のすべての通信をモック化します。

<!-- prettier-ignore -->
```js
import axios from 'axios'
import mock from './mocks/$mock.js'

mock()

axios.get('https://example.com/api/foo').then(response => {
  /* ... */
})
```

#### 特定のインスタンスのみモックにする

[axios のインスタンス][axios-instance] ごとにモック化することもできます。

<!-- prettier-ignore -->
```js
import axios from 'axios'
import mock from './mocks/$mock.js'

const client = axios.create({ baseURL: 'https://example.com/api' })

mock(client)

client.get('/foo').then(response => {
  /* ... */
})

// axios はモックされません
axios.get('https://example.com/api/foo').catch(error => {
  console.log(error.response.status) // 404
})
```

### 関数

axios-mock-server ではいくつかの組み込み関数を利用することができます。

#### `setDelayTime(millisecond: number): void`

レスポンスの遅延をシミュレートします。

<!-- prettier-ignore -->
```js
import axios from 'axios'
import mock from './mocks/$mock.js'

mock().setDelayTime(500)

console.time()
axios.get('https://example.com/api/foo').then(() => {
  console.timeEnd() // default: 506.590ms
})
```

#### `enableLog(): void` と `disableLog(): void`

リクエストログの出力を切り替えます。

<!-- prettier-ignore -->
```js
import axios from 'axios'
import mock from './mocks/$mock.js'

const mockServer = mock()

;(async () => {
  // 有効にする
  mockServer.enableLog()
  await axios.get('/foo', { baseURL: 'https://example.com/api', params: { bar: 'baz' } }) // 標準出力 -> [mock] get: /foo?bar=baz => 200

  // 無効にする
  mockServer.disableLog()
  await axios.get('/foo', { baseURL: 'https://example.com/api', params: { bar: 'baz' } }) // 標準出力 ->
})()
```

### TypeScript

axios-mock-server には [TypeScript][typescript] の定義が含まれています。

### 注意事項

#### `.gitignore`

axios-mock-server がビルドで生成する `$mock.js`、または `$mock.ts` を [Git][git] の監視から除外してください。

```sh
$ echo "\$mock.*" >> .gitignore
```

#### `@ts-ignore`, `eslint-disable`

[TypeScript][typescript] のプロジェクトの場合は、`$ mock.ts` をインポートする上の行に `// @ ts-ignore` コメントを追加します。
[typescript-eslint][typescript-eslint] で [`@typescript-eslint/ban-ts-ignore`][typescript-eslint-ban-ts-ignore] ルールが有効になっている場合、[ESLint][eslint] から `// ts-ignore` コメントを除外してください。

<!-- prettier-ignore -->
```ts
// eslint-disable-next-line @typescript-eslint/ban-ts-ignore
// @ts-ignore: Cannot find module
import mock from './mocks/$mock'
```

## トラブルシューティング

### TypeScript で `The expected type comes from property 'get' which is declared here on type 'MockMethods'` のエラー

[TypeScript][typescript] で非同期にレスポンスを返す場合、レスポンスを配列にしようとすると型が一致しないためにエラーになります。  
`MockResponse` をアサーションするか、オブジェクトで返すようにしてください。

エラーになる例（**axios-mock-server のビルドは通ることに注意してください！**）

<!-- prettier-ignore -->
```ts
import { MockMethods } from 'axios-mock-server'

const methods: MockMethods = {
  async get() {
    await new Promise(resolve => setTimeout(resolve, 100))
    return [200, { foo: 'bar' }] // Error
  }
}

export default methods
```

`MockResponse` をアサーションして解決します。

<!-- prettier-ignore -->
```ts
import { MockMethods, MockResponse } from 'axios-mock-server'

const methods: MockMethods = {
  async get() {
    await new Promise(resolve => setTimeout(resolve, 100))
    return [200, { foo: 'bar' }] as MockResponse // Type safe
  }
}

export default methods
```

レスポンスをオブジェクトにすることができればアサーションも不要です。

<!-- prettier-ignore -->
```ts
import { MockMethods } from 'axios-mock-server'

const methods: MockMethods = {
  async get() {
    await new Promise(resolve => setTimeout(resolve, 100))
    return { status: 200, data: { foo: 'bar' } } // Type safe
  }
}

export default methods
```

## Command Line Interface のオプション

Command Line Interface では以下のオプションを指定することができます。

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Type</th>
      <th>Default</th>
      <th width="100%">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td nowrap><code>--build</code><br /><code>-b</code></td>
      <td></td>
      <td></td>
      <td>
        axios-mock-server のルーティングに必要な <code>$mock.js</code>、または
        <code>$mock.ts</code> を生成します。
      </td>
    </tr>
    <tr>
      <td nowrap><code>--config</code><br /><code>-c</code></td>
      <td><code>string</code></td>
      <td><code>".mockserverrc"</code></td>
      <td>設定ファイルまでのパスを指定します。</td>
    </tr>
    <tr>
      <td nowrap><code>--watch</code><br /><code>-w</code></td>
      <td></td>
      <td></td>
      <td>
        監視モードを有効にします。<br />
        API のエンドポイントとなるファイルの増減に合わせて
        <code>$mock.js</code>、または <code>$mock.ts</code> を再生成します。
      </td>
    </tr>
    <tr>
      <td nowrap><code>--version</code><br /><code>-v</code></td>
      <td></td>
      <td></td>
      <td>axios-mock-server のバージョンを表示します。</td>
    </tr>
  </tbody>
</table>

## 設定

設定は `.mockserverrc` ファイルに JSON の構文で記述します。

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Type</th>
      <th>Default</th>
      <th width="100%">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>input</code></td>
      <td><code>string | string[]</code></td>
      <td><code>"mocks" or "apis"</code></td>
      <td>
        API のエンドポイントとなるファイルが保存されているディレクトリを指定します。<br />
        複数のディレクトリを指定した場合は、それぞれのディレクトリに
        <code>$mock.js</code>、または <code>$mock.ts</code> を生成します。
      </td>
    </tr>
    <tr>
      <td><code>outputExt</code></td>
      <td><code>"js" | "ts"</code></td>
      <td></td>
      <td>
        生成するファイルの拡張子を指定します。<br />
        デフォルトは API エンドポイントのファイルの内容から自動で設定します。
      </td>
    </tr>
    <tr>
      <td><code>target</code></td>
      <td><code>"es6" | "cjs"</code></td>
      <td></td>
      <td>
        生成するモジュールのコードを指定します。<br />
        デフォルトは API エンドポイントのファイルの拡張子から自動で設定します。
      </td>
    </tr>
  </tbody>
</table>

## ライセンス

axios-mock-server は [MIT License][axios-mock-server-license] のもとで利用を許諾します。

<!-- URL: axios-mock-server -->

[axios-mock-server-examples]: https://github.com/m-mitsuhide/axios-mock-server/tree/develop/examples
[axios-mock-server-license]: https://github.com/m-mitsuhide/axios-mock-server/blob/develop/LICENSE

<!-- URL: Badges -->

[badge-bundlephobia-url]: https://bundlephobia.com/result?p=axios-mock-server@latest
[badge-bundlephobia]: https://img.shields.io/bundlephobia/min/axios-mock-server
[badge-ci-url]: https://circleci.com/gh/m-mitsuhide/axios-mock-server
[badge-ci]: https://img.shields.io/circleci/build/github/m-mitsuhide/axios-mock-server.svg?label=test
[badge-coverage-url]: https://codecov.io/gh/m-mitsuhide/axios-mock-server
[badge-coverage]: https://img.shields.io/codecov/c/github/m-mitsuhide/axios-mock-server.svg
[badge-dependabot]: https://api.dependabot.com/badges/status?host=github&repo=m-mitsuhide/axios-mock-server
[badge-lgtm-url]: https://lgtm.com/projects/g/m-mitsuhide/axios-mock-server/context:javascript
[badge-lgtm]: https://img.shields.io/lgtm/grade/javascript/g/m-mitsuhide/axios-mock-server.svg
[badge-license]: https://img.shields.io/npm/l/axios-mock-server
[badge-npm-url]: https://www.npmjs.com/package/axios-mock-server
[badge-npm]: https://img.shields.io/npm/v/axios-mock-server

<!-- URL: General -->

[axios-instance]: https://github.com/axios/axios#creating-an-instance
[axios]: https://github.com/axios/axios
[dependabot]: https://dependabot.com
[eslint]: https://eslint.org
[git]: https://git-scm.com/
[javascript]: https://developer.mozilla.org/en-US/docs/Web/JavaScript
[nodejs]: https://nodejs.org/
[npm]: https://www.npmjs.com/
[nuxtjs-axios]: https://github.com/nuxt-community/axios-module
[nuxtjs-routing]: https://nuxtjs.org/guide/routing
[nuxtjs]: https://nuxtjs.org/
[typescript-eslint-ban-ts-ignore]: https://github.com/typescript-eslint/typescript-eslint/blob/master/packages/eslint-plugin/docs/rules/ban-ts-ignore.md
[typescript-eslint]: https://github.com/typescript-eslint/typescript-eslint
[typescript]: https://www.typescriptlang.org/
[yarn]: https://yarnpkg.com/
